//jshint esversion:6


var testContent = "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Duis vel ante et augue suscipit ornare ac nec tortor. Sed quis efficitur nunc. In a lobortis neque, eu interdum leo. Suspendisse molestie eget nibh et ultricies. Ut vestibulum eros sapien, ut consectetur leo laoreet non. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Etiam congue luctus nibh, varius congue nibh laoreet non. Fusce vitae sapien in ante molestie hendrerit. Nulla maximus aliquam leo, vel sollicitudin ipsum faucibus in. Donec gravida consequat gravida. Duis rutrum gravida nunc iaculis semper. Sed arcu felis, interdum sit amet congue eu, varius id lacus. \nDonec consectetur tincidunt sapien vitae auctor. Nunc laoreet auctor varius. Curabitur eu tempor turpis, quis euismod sem. Nunc hendrerit eget odio quis scelerisque. Curabitur blandit quis mauris efficitur vulputate. Interdum et malesuada fames ac ante ipsum primis in faucibus. Nunc imperdiet nisl dui, quis pretium tortor commodo eget. Duis sem libero, accumsan sed elit in, interdum convallis augue. Vivamus pulvinar leo purus, vitae egestas magna egestas eu. Donec id lacinia velit. Donec ut pretium felis.\n Sed urna tortor, cursus sit amet tristique in, condimentum vitae leo. Sed et pellentesque nisl. Quisque maximus quam dolor, facilisis posuere odio molestie fermentum. Aenean neque justo, eleifend et lacinia in, convallis vitae dui. Donec porta lacinia diam ac convallis. Nulla eget purus eget ante rutrum molestie. Suspendisse id porta felis. \n Proin tempus non nunc vel vulputate. Cras vitae mauris finibus, vehicula libero eget, porttitor tortor. Phasellus ullamcorper diam eget felis ullamcorper pharetra. Integer scelerisque varius mi ut maximus. In hac habitasse platea dictumst. Suspendisse faucibus tincidunt auctor. Praesent varius, sem ac aliquet aliquet, sem orci efficitur quam, vitae tincidunt est leo at lacus. Morbi sollicitudin nibh ligula, sed rutrum sapien mollis in. Sed ornare lectus eu velit rhoncus scelerisque. Vestibulum eu tempor diam. Donec a sapien nec augue posuere mollis. Duis commodo elit nec tellus elementum tempus. Vestibulum ante ipsum primis in faucibus orci luctus et ultrices posuere cubilia Curae. \nSed placerat urna odio, at lobortis ante consectetur ut. Curabitur ac ornare purus. Nam lobortis erat tortor, id dapibus massa interdum quis. In arcu sem, rutrum sit amet volutpat et, sagittis sit amet turpis. In consequat risus dui, vitae pellentesque mauris egestas in. Maecenas ut tortor blandit, cursus lectus at, commodo lacus. Donec purus dolor, congue a libero quis, ultricies commodo nulla. Praesent lobortis maximus mi a feugiat. Sed eu nibh a nisi mollis dictum. Quisque rhoncus diam quis pulvinar bibendum. Aliquam erat volutpat. Phasellus fringilla, tellus non sodales condimentum, sapien risus elementum nulla, nec sollicitudin nulla ligula at nunc. Nunc sit amet ante sem. Nulla facilisi.\n Proin laoreet urna sit amet arcu rhoncus elementum. Vivamus eget mauris vitae enim commodo tristique consequat eu magna. Aliquam id dui lectus. Nullam interdum placerat pretium. In venenatis quis urna id scelerisque. Donec ut velit neque. Curabitur viverra, lorem dapibus imperdiet tincidunt, arcu magna bibendum purus, eget interdum ipsum tortor id ipsum. Etiam non accumsan odio, eu mattis orci.\nVivamus tortor risus, accumsan ac nibh id, ornare varius massa. Praesent sed sapien eu nibh vestibulum molestie. Nullam ac ex tristique, iaculis dolor a, sollicitudin magna. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Cras nec ipsum condimentum, mollis mauris id, tincidunt lacus. Etiam vel ligula vitae erat maximus vehicula non eu quam. Quisque ac mauris in purus vestibulum mattis. Nam eleifend, quam molestie dapibus ornare, ex odio tempus leo, eget blandit risus velit a mauris. Integer nec sodales leo. Aliquam finibus venenatis magna, at scelerisque urna malesuada non. Sed cursus felis vel lacus volutpat commodo. Praesent velit lacus, sodales id augue at, ultrices condimentum arcu. Donec a mauris at ipsum condimentum commodo sed sit amet ligula. Proin sed malesuada lacus.\nSed interdum mollis nulla, sit amet cursus libero accumsan sed. Nunc vehicula justo non lacus mattis eleifend. Ut euismod luctus tellus, at malesuada velit suscipit id. Vestibulum pellentesque ornare metus. Morbi ultricies tellus a eros placerat egestas. Aenean et mauris imperdiet, sodales mi et, elementum nisi. Morbi ullamcorper quis arcu non efficitur. Quisque at feugiat eros. Proin bibendum dignissim eleifend. Donec et mollis diam. Curabitur fringilla orci eu lobortis tincidunt. Nullam porttitor nunc at ante pulvinar mattis. Nunc iaculis eget neque sit amet eleifend. \nProin vel risus tellus. Pellentesque volutpat suscipit purus, sit amet rutrum velit egestas sed. Morbi nec velit et justo fermentum auctor. Nulla eu ex sed urna viverra interdum in ac felis. Cras ullamcorper arcu ligula, quis interdum ex vestibulum sed. Praesent tincidunt nulla sit amet urna tincidunt volutpat. Donec lobortis, augue id sodales feugiat, tellus augue pulvinar lorem, eu consequat orci lectus vitae ligula. Nullam posuere id lectus vel maximus. Quisque ullamcorper augue sed pretium sollicitudin. Aenean erat nulla, mattis non tortor non, elementum gravida nunc.\n Quisque eget tincidunt metus. Quisque neque arcu, rutrum at massa vitae, pretium euismod nunc. Sed bibendum auctor iaculis. Morbi lacinia purus nulla, nec posuere ipsum convallis nec. Phasellus sed arcu efficitur, lacinia odio in, facilisis mi. Maecenas lacus nisi, molestie vitae lorem eu, finibus vestibulum nisl. In a fermentum ante. Proin et velit a enim blandit aliquam in at sem. Aenean sodales risus dui, at hendrerit mi maximus quis. Donec eget condimentum dolor. Praesent leo nulla, semper tincidunt mauris nec, pellentesque ornare diam. Nulla mi massa, efficitur sit amet libero vel, porta egestas libero. Suspendisse sit amet euismod elit, et semper mi. In ultrices mi eget convallis mattis. Sed et maximus lacus. Vivamus urna ante, tempus non ligula ac, hendrerit maximus mass";

var textArea = document.querySelector('#doc_view');
var currentDocument = new Doc("test", testContent);
var currentHighlighterColor;
// //future implementation
var openDocuments = [];
var currentLabel;

//download highlights
$('button').click(function (e) {
  if (e.target.id === 'export') {
    if (openDocuments.length === 0) {
      alert("Error: No data to download!");
      return;
    }

    console.log(JSON.stringify(openDocuments));
  }
});
console.log(currentLabel);

$(textArea).val(currentDocument.text);

//When the user releases the mouse, highlight the selected text
textArea.addEventListener("mouseup", handleHighlight);

function handleHighlight() {
    if (currentLabel == null || currentHighlighterColor == null) {
        alert("Error: Please select a label and highlighter color first");
        return;
    }
    let scrollPosition = textArea.scrollTop;
    let range = getRangeOfSelectedText();

    if (selectedInputRangeIsValid(range)) {
        //build the annotation
        let content = extractSelectedContent(range);
        let notation = new Annotation(
            range,
            content,
            currentHighlighterColor,
            currentLabel
        );

        //then add this annotation to the current document
        currentDocument.annotations.push(notation);

        renderTextareaHighlights();
        textArea.scrollTop = scrollPosition;
    }
}

//returns the starting and ending position of the currently selected text
getRangeOfSelectedText = function () {
    let start = textArea.selectionStart;
    let end = textArea.selectionEnd;
    return {
        "startPosition": start,
        "endPosition": end
    }
};

function selectedInputRangeIsValid(range){
  console.log(range.startPosition, range.endPosition);
    return range.startPosition !== range.endPosition;
}

function extractSelectedContent(range){
    return textArea.value.substring(range.startPosition, range.endPosition);
}

//Actually draws the highlights on the textarea.
renderTextareaHighlights = function () {
    //array to hold everything that needs to be highlighted in doc
    let highlights = [];

    //loop through the stored annotations and append to the array as a dictionary
    currentDocument.annotations.forEach(function(annotation) {
        let single_highlight = {};

        single_highlight.highlight = [annotation.range.startPosition, annotation.range.endPosition];
        single_highlight.className = annotation.highlighter_color;

        highlights.push(single_highlight);
    });

    //then highlight based on that array
    $('textarea').highlightWithinTextarea({
        highlight: highlights
    });
};

//change the document's label context
$('.label').on('click', function (e) {
  console.log(e.currentTarget.getAttribute('value'));
  currentLabel = event.currentTarget.getAttribute('value');
  $('.label').removeClass('label-selected');
  $(e.currentTarget).addClass('label-selected');
});

//change document's highlighter color context
$('.highlight-color').on('click', function (e) {
  console.log(e.currentTarget.id);
  currentHighlighterColor = e.currentTarget.id;
  $('.highlight-color').removeClass('color-selected');
  $(e.currentTarget).addClass('label-selected');
  renderTextareaHighlights();
});

function makeHeight() {
  $('textarea').each(function () {
    $(this).height($(this).prop('scrollHeight'));
  });
};

$(window).on('resize', function () {
  makeHeight();
});

makeHeight();
