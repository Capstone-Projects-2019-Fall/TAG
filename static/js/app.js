//jshint esversion:6

var testContent = 'Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Sit amet nisl suscipit adipiscing. Consectetur adipiscing elit ut aliquam purus sit amet luctus venenatis. Non arcu risus quis varius quam quisque id diam. Mauris augue neque gravida in fermentum. Auctor elit sed vulputate mi sit amet mauris commodo. Urna cursus eget nunc scelerisque viverra mauris in aliquam sem. Vulputate mi sit amet mauris. Feugiat nisl pretium fusce id velit ut tortor pretium. Leo duis ut diam quam. Eu consequat ac felis donec et odio. Amet venenatis urna cursus eget nunc scelerisque viverra mauris. Tortor vitae purus faucibus ornare suspendisse sed nisi lacus sed. Enim nulla aliquet porttitor lacus luctus. Velit egestas dui id ornare arcu odio ut sem nulla. \nRisus nullam eget felis eget nunc lobortis mattis aliquam faucibus. Maecenas pharetra convallis posuere morbi leo urna. Est ante in nibh mauris cursus mattis molestie a. Tortor vitae purus faucibus ornare suspendisse sed. Suscipit tellus mauris a diam. Scelerisque mauris pellentesque pulvinar pellentesque habitant morbi tristique senectus. Nunc consequat interdum varius sit amet mattis. Adipiscing commodo elit at imperdiet dui accumsan. Pretium fusce id velit ut tortor pretium viverra. Dictumst vestibulum rhoncus est pellentesque elit. Mus mauris vitae ultricies leo integer malesuada nunc vel. Mauris nunc congue nisi vitae suscipit tellus mauris a. Arcu risus quis varius quam quisque. Dictum varius duis at consectetur lorem donec massa sapien faucibus. Bibendum ut tristique et egestas. \nDictum sit amet justo donec enim diam vulputate ut. Maecenas pharetra convallis posuere morbi leo. Et sollicitudin ac orci phasellus egestas tellus. Ornare suspendisse sed nisi lacus. At volutpat diam ut venenatis tellus in metus vulputate. Nullam ac tortor vitae purus. Iaculis nunc sed augue lacus viverra vitae congue eu. Dolor sit amet consectetur adipiscing. Eleifend donec pretium vulputate sapien nec sagittis aliquam malesuada bibendum. Enim nec dui nunc mattis enim ut tellus. Velit laoreet id donec ultrices tincidunt arcu non sodales. Pretium lectus quam id leo. Purus non enim praesent elementum facilisis leo vel fringilla est. Risus in hendrerit gravida rutrum. Diam quis enim lobortis scelerisque fermentum dui. Quam quisque id diam vel quam. Sit amet consectetur adipiscing elit ut aliquam purus. \nUltrices mi tempus imperdiet nulla malesuada pellentesque. Leo a diam sollicitudin tempor id eu nisl nunc. Porta nibh venenatis cras sed. Tellus molestie nunc non blandit massa. Sed faucibus turpis in eu mi. Pretium lectus quam id leo in vitae turpis massa sed. At quis risus sed vulputate odio ut enim. Risus viverra adipiscing at in tellus integer feugiat scelerisque. Pellentesque nec nam aliquam sem. Bibendum enim facilisis gravida neque convallis a. Pretium fusce id velit ut tortor pretium viverra suspendisse. Ornare aenean euismod elementum nisi quis eleifend quam adipiscing vitae. Nullam non nisi est sit amet facilisis magna etiam. Dictum non consectetur a erat. Urna cursus eget nunc scelerisque viverra mauris in. \nSuscipit adipiscing bibendum est ultricies integer quis auctor elit. Dolor sit amet consectetur adipiscing. Erat pellentesque adipiscing commodo elit at imperdiet dui accumsan. Sit amet volutpat consequat mauris nunc congue nisi. Ornare aenean euismod elementum nisi quis eleifend quam adipiscing vitae. Quis varius quam quisque id diam vel quam elementum pulvinar. Amet venenatis urna cursus eget nunc. Augue ut lectus arcu bibendum. Pretium viverra suspendisse potenti nullam ac tortor vitae purus faucibus. Penatibus et magnis dis parturient montes nascetur ridiculus mus. In aliquam sem fringilla ut morbi tincidunt augue. Imperdiet massa tincidunt nunc pulvinar sapien et ligula. Amet mattis vulputate enim nulla aliquet porttitor lacus luctus. Amet risus nullam eget felis eget nunc lobortis mattis. A iaculis at erat pellentesque. Integer vitae justo eget magna fermentum iaculis eu. Pretium lectus quam id leo in vitae. \nTempor commodo ullamcorper a lacus vestibulum sed. Nec feugiat nisl pretium fusce id velit. Aliquam sem et tortor consequat. Urna nunc id cursus metus aliquam eleifend mi. Sed blandit libero volutpat sed cras. Arcu cursus vitae congue mauris rhoncus aenean vel elit scelerisque. Bibendum at varius vel pharetra. Amet risus nullam eget felis eget nunc lobortis mattis aliquam. Lorem ipsum dolor sit amet consectetur adipiscing elit ut aliquam. Suspendisse sed nisi lacus sed viverra. Enim sit amet venenatis urna cursus. Vivamus at augue eget arcu dictum varius. Lacus sed viverra tellus in hac habitasse. Dictum fusce ut placerat orci nulla pellentesque dignissim. Volutpat lacus laoreet non curabitur gravida. Neque egestas congue quisque egestas diam in arcu. Id diam vel quam elementum pulvinar etiam. Enim sed faucibus turpis in. Amet consectetur adipiscing elit duis. Et magnis dis parturient montes nascetur. \nCommodo ullamcorper a lacus vestibulum sed arcu non odio euismod. Eget velit aliquet sagittis id consectetur purus ut faucibus pulvinar. In ornare quam viverra orci sagittis eu volutpat. Eget est lorem ipsum dolor sit amet consectetur. Est ante in nibh mauris cursus mattis molestie a iaculis. Iaculis nunc sed augue lacus viverra vitae congue eu consequat. Lacus suspendisse faucibus interdum posuere lorem ipsum. Arcu felis bibendum ut tristique. Odio tempor orci dapibus ultrices. Sagittis eu volutpat odio facilisis mauris. Netus et malesuada fames ac turpis egestas maecenas pharetra. Morbi enim nunc faucibus a pellentesque sit. Eget nunc scelerisque viverra mauris. Vitae aliquet nec ullamcorper sit amet risus nullam. Consectetur a erat nam at lectus urna duis convallis convallis. Cras adipiscing enim eu turpis egestas pretium aenean pharetra. Id leo in vitae turpis. A erat nam at lectus urna duis. Augue neque gravida in fermentum et sollicitudin ac orci. \nAdipiscing enim eu turpis egestas pretium aenean pharetra. Ullamcorper a lacus vestibulum sed arcu non. Egestas tellus rutrum tellus pellentesque eu tincidunt tortor aliquam nulla. Amet venenatis urna cursus eget nunc scelerisque viverra mauris in. Lorem ipsum dolor sit amet consectetur. Urna nec tincidunt praesent semper feugiat nibh. Ultrices mi tempus imperdiet nulla malesuada pellentesque elit eget. Risus feugiat in ante metus. Velit scelerisque in dictum non consectetur a erat. Risus commodo viverra maecenas accumsan lacus. Est ante in nibh mauris cursus mattis. \nMagnis dis parturient montes nascetur ridiculus. Sit amet nisl purus in mollis nunc. Vitae nunc sed velit dignissim. In arcu cursus euismod quis viverra nibh cras pulvinar. Feugiat in ante metus dictum at tempor commodo. Dui vivamus arcu felis bibendum ut tristique. Vulputate odio ut enim blandit volutpat maecenas volutpat. Tincidunt tortor aliquam nulla facilisi cras fermentum. Faucibus vitae aliquet nec ullamcorper sit amet risus nullam. Scelerisque eu ultrices vitae auctor eu augue ut. Mauris in aliquam sem fringilla ut morbi. Eu turpis egestas pretium aenean pharetra magna ac placerat vestibulum. \nSem fringilla ut morbi tincidunt augue interdum. Faucibus nisl tincidunt eget nullam non nisi est. Nam at lectus urna duis convallis convallis. Sagittis orci a scelerisque purus semper eget duis at tellus. Duis convallis convallis tellus id interdum velit. Vestibulum lorem sed risus ultricies tristique nulla aliquet enim. Id donec ultrices tincidunt arcu non sodales neque sodales. Senectus et netus et malesuada fames ac turpis egestas. Porta non pulvinar neque laoreet suspendisse interdum consectetur libero. Nam at lectus urna duis convallis convallis tellus id interdum. Est ullamcorper eget nulla facilisi etiam dignissim diam quis. Nulla aliquet porttitor lacus luctus accumsan tortor posuere ac ut. \nAdipiscing vitae proin sagittis nisl rhoncus mattis rhoncus urna. Consectetur adipiscing elit ut aliquam purus sit amet. Nibh tellus molestie nunc non blandit massa enim. A diam sollicitudin tempor id eu nisl. In iaculis nunc sed augue. Cras sed felis eget velit. Faucibus vitae aliquet nec ullamcorper sit amet risus. Proin sagittis nisl rhoncus mattis rhoncus urna. Porttitor lacus luctus accumsan tortor posuere ac ut consequat. Magnis dis parturient montes nascetur ridiculus. Eget dolor morbi non arcu risus. Velit egestas dui id ornare arcu odio. Eleifend quam adipiscing vitae proin sagittis nisl. At augue eget arcu dictum varius duis at consectetur lorem. Integer feugiat scelerisque varius morbi enim nunc. Etiam non quam lacus suspendisse faucibus interdum posuere. Facilisis sed odio morbi quis commodo odio aenean sed. Fringilla ut morbi tincidunt augue interdum. Nunc scelerisque viverra mauris in. Pellentesque dignissim enim sit amet. \nAnte metus dictum at tempor commodo ullamcorper a lacus vestibulum. Volutpat maecenas volutpat blandit aliquam etiam erat velit scelerisque in. Vestibulum rhoncus est pellentesque elit. Porttitor leo a diam sollicitudin tempor id. Magna fringilla urna porttitor rhoncus. Tincidunt lobortis feugiat vivamus at augue eget arcu dictum. Fames ac turpis egestas integer eget aliquet nibh praesent. Sed blandit libero volutpat sed cras ornare. Quis eleifend quam adipiscing vitae proin. Ut enim blandit volutpat maecenas volutpat blandit aliquam etiam erat. Eget mauris pharetra et ultrices. Amet commodo nulla facilisi nullam vehicula ipsum a arcu. Aliquet enim tortor at auctor urna nunc id cursus.';

/* ---------- page setup ---------- */
var textArea = $('#doc-view');
var tagModel = new TagModel();

//testing purposes //remove when implementing dynamic adding
addDoc(makeFakeDoc());
addLabel(makeRandName());


/* ---------- events ---------- */
//download highlights
$('#download').click(function () {
  console.log("JSON download requested...")
  if (tagModel.openDocs.length === 0) {
    alert('Error: No data to download!');
    return;
  }
  let blob = new Blob([tagModel.exportAsString()], {type: 'application/JSON'});
  let url = window.URL.createObjectURL(blob);
  console.log("Generated object URL: " + url);
  document.getElementById('download_link').href = url;
  document.getElementById('download_link').click();
  window.URL.revokeObjectURL(url);
});

//on mouse1 release
textArea.on('mouseup', function () {
  //if pressed with alt key...
  if (event.altKey) {
    //...then remove the annotation
    let position = textArea[0].selectionStart;
    tagModel.removeAnnotation(position);
  }

  else {
    let range = {
      'startPosition': textArea[0].selectionStart,
      'endPosition': textArea[0].selectionEnd
    };
    if (range.startPosition !== range.endPosition) {
      console.log("Highlighted: " + range.startPosition + "-" + range.endPosition);
    }
    if (range.startPosition < range.endPosition) {
      tagModel.addAnnotation(range);
    } else {
      return;
    }
  }
  renderTextareaHighlights();
});

$('#add-label').on('click', function () {
  // todo add name checking // no spaces
  // todo change to real add function
  var newLabel = makeRandName();
  console.log("CSS: Creating new category: [" + newLabel + "]");
  addLabel(newLabel);
});

//change the document's label context
$('#label-list').on('click', '.label', function () {
  console.log("Selected label: [" + this.getAttribute('value') + "]");

  //change label selection
  tagModel.currentCategory = this.getAttribute('value');
  //remove label-selected from all
  $('.label').attr('id', '');
  //add label-selected to clicked
  $(this).attr('id', 'label-selected');
});

//edit label name
$('#label-list').on('dblclick', '.label-name', function () {
  //enble editing
  this.contentEditable = true;
  //open textbox
  $(this).focus().select();
});

//stopped editing label name
$('#label-list').on('blur', '.label-name', function () {
  //disable editing
  this.contentEditable = false;

  //fix whitespace and create new label name with no spaces (class names can't have spaces)
  $(this).text($(this).text().trim());
  let newName = $(this).text().replace(/ /g, "_");

  //check if the name is the same as previous
  if (newName === tagModel.currentCategory) {
    console.log('Aborting: Category is the same name as before');
    return;
  }

  //check for valid label name
  if ((tagModel.checkCategory(newName) >= 0) || newName === '') {
    console.log('Aborting: Invalid label name: "' + newName + '"');
    $(this).text(tagModel.currentCategory);
    return;
  }

  // update styling for category
  $('#' + tagModel.currentCategory + '-style').remove();
  $('head').append(
    $('<style/>', {
      id: newName + '-style',
      html: '.hwt-content .label_' + newName + ' {background-color:' + tagModel.getColor(newName) + ';}'
    })
  );

  // update category name in list
  $('.label[value=' + tagModel.currentCategory + ']').attr('value', newName);

  tagModel.renameCategory(newName);
  renderTextareaHighlights();
});

//invoke colorpicker on icon click
$('#label-list').on('click', '.colorChange', function () {
  $(this).parent().children('input').click();   //invoke color picker
});

//change label color
$('#label-list').on('change', '.colorChangePicker', function () {
  //TODO: specify original color and label
  console.log('Highlight color changed to: ' + this.value);

  //update colors on page
  $('.label[value=' + tagModel.currentCategory + ']').css('background-color', this.value);
  $('#' + tagModel.currentCategory + '-style').html(
  '.hwt-content .label_' + tagModel.currentCategory + ' {background-color: ' + this.value + ';}'
  );
  tagModel.changeColor(this.value);
});

// add document button
$('#add-document').on('click', function () {
  // todo add name checking // no spaces
  // todo change to real add function
  var newDoc = makeFakeDoc();
  addDoc(newDoc);
});

// change document render
$('#doc-list').on('click', '.doc-name', function () {
  console.log("doc-name-click: " + this.getAttribute('value'));
  tagModel.setCurrentDoc(this.getAttribute('value'));
  textArea.html(tagModel.currentDoc.text);
  renderTextareaHighlights();
  resize();
  $(window).scrollTop(0);
});

// update size when window is resized
$(window).on('resize', function () {
  let scrollPercent = $(window).scrollTop() / $(document).height();
  resize();
  $(window).scrollTop(scrollPercent * $(document).height());
});

/* ---------------functions---------------- */

//add new document
function addDoc(doc) {
  tagModel.addDoc(doc);

  if (tagModel.openDocs.length === 1) {
    tagModel.setCurrentDoc(doc.title);
    textArea.html(tagModel.currentDoc.text);
    resize();
  }
  $('#doc-list').append(
    $('<h6/>', {
      class: 'doc-name',
      value: doc.title,
      html: doc.title
    }));
}

//Actually draws the highlights on the textarea.
function renderTextareaHighlights() {
  //array to hold everything that needs to be highlighted in doc
  let highlights = [];

  //loop through the stored annotations and append to the array as a dictionary
  tagModel.currentDoc.annotations.forEach(function (annotation) {
    let single_highlight = {
      highlight: [annotation.range.startPosition, annotation.range.endPosition],
      className: 'label_' + annotation.label
    };
    highlights.push(single_highlight);
  });

  //then highlight based on that array
  $('textarea').highlightWithinTextarea({
    highlight: highlights
  });
}

//add new label
function addLabel(name, color = null) {
  if (tagModel.checkCategory(name) === -1) {
    if (color === null) {
      color = makeRandColor();
    }
    tagModel.addCategory(name, color);

    // add highlight rule to page
    $('head').append(
      $('<style/>', {
        id: name + '-style',
        html: '.hwt-content .label_' + name + ' {background-color: ' + color + ';}'
      })
    );

    // add label to page
    $('#label-list').append(
      $('<div/>', {
        class: 'list-group-item py-2 px-3 label',
        value: name,
        style: "background-color: " + color,
        html: '<div class="label-name">' + name + '</div><img src="https://img.icons8.com/metro/24/000000/color-dropper.png" class="colorChange" style="float: right;"><input class="colorChangePicker" type="color" style="height:0; width:0; visibility: hidden;">'
      }));

    // first color => make current category the color
    if (tagModel.categories.length === 1) {
      tagModel.currentCategory = name;
      $('.label[value=' + name + ']').attr('id', 'label-selected');
    }
  } else {
    console.log('Failed to add label "' + name + '": label already exists!');
  }
}

//update height on window resize and keep scroll position
function resize() {
  textArea.height('auto');
  textArea.height(textArea.prop('scrollHeight') + 1);
}

// make fake document  // delete when done
function makeFakeDoc() {
  let randName = makeRandName();
  let startPosition = randomIntFromInterval(0, parseInt(testContent.length / 4));
  let endPosition = randomIntFromInterval(startPosition, testContent.length);
  var newDocument = new Doc(randName, testContent.substring(startPosition, endPosition));

  function randomIntFromInterval(min, max) { // min and max included
    return Math.floor(Math.random() * (max - min + 1) + min);
  }

  return newDocument;
}

// make fake name // delete when done
function makeRandName() {
  return parseInt(Math.random() * Math.pow(10, 14)).toString(36);
}

function makeRandColor() {
  return "#000000".replace(/0/g, function () {
    return (~~(Math.random() * 10) + 6).toString(16);
  });
}
