//jshint esversion:6


var testContent = 'Lorem ipsum dolor sit amet, consectetur adipiscing elit. Duis vel ante et augue suscipit ornare ac nec tortor. Sed quis efficitur nunc. In a lobortis neque, eu interdum leo. Suspendisse molestie eget nibh et ultricies. Ut vestibulum eros sapien, ut consectetur leo laoreet non. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Etiam congue luctus nibh, varius congue nibh laoreet non. Fusce vitae sapien in ante molestie hendrerit. Nulla maximus aliquam leo, vel sollicitudin ipsum faucibus in. Donec gravida consequat gravida. Duis rutrum gravida nunc iaculis semper. Sed arcu felis, interdum sit amet congue eu, varius id lacus. \nDonec consectetur tincidunt sapien vitae auctor. Nunc laoreet auctor varius. Curabitur eu tempor turpis, quis euismod sem. Nunc hendrerit eget odio quis scelerisque. Curabitur blandit quis mauris efficitur vulputate. Interdum et malesuada fames ac ante ipsum primis in faucibus. Nunc imperdiet nisl dui, quis pretium tortor commodo eget. Duis sem libero, accumsan sed elit in, interdum convallis augue. Vivamus pulvinar leo purus, vitae egestas magna egestas eu. Donec id lacinia velit. Donec ut pretium felis.\n Sed urna tortor, cursus sit amet tristique in, condimentum vitae leo. Sed et pellentesque nisl. Quisque maximus quam dolor, facilisis posuere odio molestie fermentum. Aenean neque justo, eleifend et lacinia in, convallis vitae dui. Donec porta lacinia diam ac convallis. Nulla eget purus eget ante rutrum molestie. Suspendisse id porta felis. \n Proin tempus non nunc vel vulputate. Cras vitae mauris finibus, vehicula libero eget, porttitor tortor. Phasellus ullamcorper diam eget felis ullamcorper pharetra. Integer scelerisque varius mi ut maximus. In hac habitasse platea dictumst. Suspendisse faucibus tincidunt auctor. Praesent varius, sem ac aliquet aliquet, sem orci efficitur quam, vitae tincidunt est leo at lacus. Morbi sollicitudin nibh ligula, sed rutrum sapien mollis in. Sed ornare lectus eu velit rhoncus scelerisque. Vestibulum eu tempor diam. Donec a sapien nec augue posuere mollis. Duis commodo elit nec tellus elementum tempus. Vestibulum ante ipsum primis in faucibus orci luctus et ultrices posuere cubilia Curae. \nSed placerat urna odio, at lobortis ante consectetur ut. Curabitur ac ornare purus. Nam lobortis erat tortor, id dapibus massa interdum quis. In arcu sem, rutrum sit amet volutpat et, sagittis sit amet turpis. In consequat risus dui, vitae pellentesque mauris egestas in. Maecenas ut tortor blandit, cursus lectus at, commodo lacus. Donec purus dolor, congue a libero quis, ultricies commodo nulla. Praesent lobortis maximus mi a feugiat. Sed eu nibh a nisi mollis dictum. Quisque rhoncus diam quis pulvinar bibendum. Aliquam erat volutpat. Phasellus fringilla, tellus non sodales condimentum, sapien risus elementum nulla, nec sollicitudin nulla ligula at nunc. Nunc sit amet ante sem. Nulla facilisi.\n Proin laoreet urna sit amet arcu rhoncus elementum. Vivamus eget mauris vitae enim commodo tristique consequat eu magna. Aliquam id dui lectus. Nullam interdum placerat pretium. In venenatis quis urna id scelerisque. Donec ut velit neque. Curabitur viverra, lorem dapibus imperdiet tincidunt, arcu magna bibendum purus, eget interdum ipsum tortor id ipsum. Etiam non accumsan odio, eu mattis orci.\nVivamus tortor risus, accumsan ac nibh id, ornare varius massa. Praesent sed sapien eu nibh vestibulum molestie. Nullam ac ex tristique, iaculis dolor a, sollicitudin magna. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Cras nec ipsum condimentum, mollis mauris id, tincidunt lacus. Etiam vel ligula vitae erat maximus vehicula non eu quam. Quisque ac mauris in purus vestibulum mattis. Nam eleifend, quam molestie dapibus ornare, ex odio tempus leo, eget blandit risus velit a mauris. Integer nec sodales leo. Aliquam finibus venenatis magna, at scelerisque urna malesuada non. Sed cursus felis vel lacus volutpat commodo. Praesent velit lacus, sodales id augue at, ultrices condimentum arcu. Donec a mauris at ipsum condimentum commodo sed sit amet ligula. Proin sed malesuada lacus.\nSed interdum mollis nulla, sit amet cursus libero accumsan sed. Nunc vehicula justo non lacus mattis eleifend. Ut euismod luctus tellus, at malesuada velit suscipit id. Vestibulum pellentesque ornare metus. Morbi ultricies tellus a eros placerat egestas. Aenean et mauris imperdiet, sodales mi et, elementum nisi. Morbi ullamcorper quis arcu non efficitur. Quisque at feugiat eros. Proin bibendum dignissim eleifend. Donec et mollis diam. Curabitur fringilla orci eu lobortis tincidunt. Nullam porttitor nunc at ante pulvinar mattis. Nunc iaculis eget neque sit amet eleifend. \nProin vel risus tellus. Pellentesque volutpat suscipit purus, sit amet rutrum velit egestas sed. Morbi nec velit et justo fermentum auctor. Nulla eu ex sed urna viverra interdum in ac felis. Cras ullamcorper arcu ligula, quis interdum ex vestibulum sed. Praesent tincidunt nulla sit amet urna tincidunt volutpat. Donec lobortis, augue id sodales feugiat, tellus augue pulvinar lorem, eu consequat orci lectus vitae ligula. Nullam posuere id lectus vel maximus. Quisque ullamcorper augue sed pretium sollicitudin. Aenean erat nulla, mattis non tortor non, elementum gravida nunc.\n Quisque eget tincidunt metus. Quisque neque arcu, rutrum at massa vitae, pretium euismod nunc. Sed bibendum auctor iaculis. Morbi lacinia purus nulla, nec posuere ipsum convallis nec. Phasellus sed arcu efficitur, lacinia odio in, facilisis mi. Maecenas lacus nisi, molestie vitae lorem eu, finibus vestibulum nisl. In a fermentum ante. Proin et velit a enim blandit aliquam in at sem. Aenean sodales risus dui, at hendrerit mi maximus quis. Donec eget condimentum dolor. Praesent leo nulla, semper tincidunt mauris nec, pellentesque ornare diam. Nulla mi massa, efficitur sit amet libero vel, porta egestas libero. Suspendisse sit amet euismod elit, et semper mi. In ultrices mi eget convallis mattis. Sed et maximus lacus. Vivamus urna ante, tempus non ligula ac, hendrerit maximus mass';

// ------------page setup------------- //

var textArea = $('#doc-view');

var tagModel = new TagModel();
var testDocument = new Doc('test', testContent);
tagModel.addDoc(testDocument);
tagModel.setCurrentDoc('test');

//testing purposes //remove when implementing dynamic adding 
addLabel('lorem', '#FF0000');
addLabel('dolor', '#FFFF00');
addLabel('rem', '#FFC0CB');
addLabel('sit', '#ADFF2F');
addLabel('say', '#00FFFF');
addLabel('help', '#800080');
addLabel('need_break');
//--//

textArea.html(tagModel.currentDoc.text);
//calling this twice fixes an issue with document not being tall enough sometimes //dunno why
textArea.height(textArea.prop('scrollHeight'));
textArea.height(textArea.prop('scrollHeight'));

// --------------events-------------- //

//download highlights
$('#export').click(function () {
  if (tagModel.hasNoDocuments()) {
    alert('Error: No data to download!');
    return;
  }
  console.log(tagModel.exportAsString());
});

//on mouse release, highlight selected text // or if alt is pressed, delete
textArea.on('mouseup', function () {
  //alt key pressed
  if (event.altKey) {
    let position = textArea[0].selectionStart;
    tagModel.removeAnnotation(position);
  } else {
    if (tagModel.currentCategory == null) {
      alert('Error: Please select a label and highlighter color first');
      return;
    }
    let range = {
      'startPosition': textArea[0].selectionStart,
      'endPosition': textArea[0].selectionEnd
    };
    tagModel.addAnnotation(range, tagModel.currentCategory);
  }
  renderTextareaHighlights();
});

//Actually draws the highlights on the textarea.
function renderTextareaHighlights() {
  //array to hold everything that needs to be highlighted in doc
  let highlights = [];

  //loop through the stored annotations and append to the array as a dictionary
  tagModel.currentDoc.annotations.forEach(function (annotation) {
    let single_highlight = {
      highlight: [annotation.range.startPosition, annotation.range.endPosition],
      className: 'label_' + annotation.label
    };
    highlights.push(single_highlight);
  });

  //then highlight based on that array
  $('textarea').highlightWithinTextarea({
    highlight: highlights
  });
};

//change the document's label context
$('.label').on('click', function () {
  console.log('labelSelected: ' + this.getAttribute('value') + '\ncolor: ' + $(this).css('background-color'));

  //change label selection
  tagModel.currentCategory = this.getAttribute('value');
  $('.label').attr('id', '');                   //remove label-selected from all
  $(this).attr('id', 'label-selected');         //add label-selected to clicked
});

//double clicked label //edit label name
$('.label-name').on('dblclick', function () {
  this.contentEditable = true;                  //enable editing
  $(this).focus().select();                     //open text box
});

//stopped editing label name //update and handle edge cases
$('.label-name').on('blur', function () {
  //disable editing
  this.contentEditable = false;

  //fix whitespace and create new label name with no spaces (class names can't have spaces)
  $(this).text($(this).text().trim());
  let newLabel = $(this).text().replace(/ /g, "_");
  console.log("Attempting to change label name from " + tagModel.currentCategory + " to " + newLabel);

  //check if the name is the same as previous
  if (newLabel === tagModel.currentCategory) {
    console.log('Aborting: Category is the same name as before');
    return -1;
  }

  //check for valid label name
  if ((tagModel.checkCatergory(newLabel) >= 0) || newLabel === '') {
    console.log('Aborting: Invalid label name: "' + newLabel + '"');
    $(this).text(tagModel.currentCategory);
    return;
  }
  
  tagModel.renameCategory(newLabel)
  renderTextareaHighlights();
});

//invoke colorpicker on icon click
$('.colorChange').on('click', function () {
  console.log('dropperClicked!');
  $(this).parent().children('input').click();   //invoke color picker
});

//change label color
$('.colorChangePicker').on('change', function () {
  console.log('colorPicked: ' + this.value);

  tagModel.changeColor(this.value);
});

//update height on window resize and keep scroll position
$(window).on('resize', function () {
  let scrollPercent = $(window).scrollTop() / $(document).height();
  textArea.height('auto');
  textArea.height(textArea.prop('scrollHeight'));
  $(window).scrollTop(scrollPercent * $(document).height());
});

// ---------------future functions---------------- //

//add new label
function addLabel(name, color = null) {
  if (tagModel.checkCategory(name) === -1) {
    if (color === null) {
      randomColor = "#000000".replace(/0/g, function () {
        return (~~(Math.random()*16)).toString(16);
      });
      color = randomColor;
    }
    tagModel.addCategory(name, color);
  } else {
    console.log('Failed to add label "' + name + '": label already exists!');
  }
};